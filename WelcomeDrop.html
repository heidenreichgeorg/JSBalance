 <!DOCTYPE html>
 <html>
   <link rel="stylesheet" href="./FBA/mobile_green.css"/>
 <head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width">
   <title>Mobile Balance - LOGIN</title>

  
</head>

<body>







   <div id='mainpage'>


      <DIV action="LOGIN" method="post" id="login">
         <h1 id="SignUp">Sign Up</h1>
         <h1 id="formClient">Client</h1>
         <h1 id="formYear">Year</h1>
         <div class="keyPanel" ondragover="dragOverHandler(event);" ondrop="dropHandler(event);">  
            <div  class="instRow"  >&nbsp;</div>            
            <div  class="instRow" id="fileupload">&nbsp;</div>            
          </div>
         
         <!--button type="submit">Login</button -->
         </DIV>
   </div>
   

   <SCRIPT type="text/javascript" src="/client.js"></SCRIPT>
   <SCRIPT type="text/javascript" src="/sheets.js"></SCRIPT>



   <SCRIPT type="text/javascript" >

var reader;
   var content;


   var formClient="";
   var formYear="";


   function readFile(event) {
      var input = event.target;

      reader = new FileReader();
      reader.onload = function(){
          var text = reader.result;
          console.log("WELCOMEDROP.HTML readFile() MAINFILE "+text);  

          postToServer("MAINFILE",text);
      };
      reader.readAsText(input.files[0]);
   }

   function dragOverHandler(ev) {
      console.log('File(s) in drop zone');

      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();
   }


function dropHandler(ev) {
   console.log('File(s) dropped');

   // Prevent default behavior (Prevent file from being opened)
   ev.preventDefault();

   if (ev.dataTransfer.items) {
   // Use DataTransferItemList interface to access the file(s)
      for (var i = 0; i < ev.dataTransfer.files.length; i++) {
         // If dropped items aren't files, reject them
         if (ev.dataTransfer.items[i].kind === 'file') {
            var item = ev.dataTransfer.files[i];


            // FUTURE
            // check extension and file name conventions
            var file = item; // .getAsFile();
            let fName = file.name;
            //console.log('FILES... file[' + i + '].name = ' + file.name);


            var fr = new FileReader();
            fr.onload = function () {
               fileBuffer = this.result;            
               console.log('UPLOAD '+fileBuffer);
               let jData = JSON.parse(fileBuffer);
               postToServer("UPLOAD",JSON.stringify(jData),showResponse);            
              
            }
            fr.readAsText(item);
         }
      }
      console.log('MANAGED');
   }
}

function showResponse(response) {
   let display = document.getElementById('fileupload');
   if(response && display) display.innerHTML=response;
}

function dripHandler(ev) {
      console.log('File(s) dropped');

      // Prevent default behavior (Prevent file from being opened)
      ev.preventDefault();

      if (ev.dataTransfer.items) {
      // Use DataTransferItemList interface to access the file(s)
         for (var i = 0; i < ev.dataTransfer.files.length; i++) {
            // If dropped items aren't files, reject them
            if (ev.dataTransfer.items[i].kind === 'file') {
               var item = ev.dataTransfer.files[i];
               var file = item; // .getAsFile();
               console.log('FILES... file[' + i + '].name = ' + file.name);

               let fName = file.name;
               if(i==0 && fName.length>10 && fName.startsWith('BOOK_') && fName.endsWith('.xlsx')) {
                  let prefix=fName.substring(5).replace(/\d/g,'');

                  formClient=prefix.substring(0,prefix.length-5);
                  let len = formClient.length;
                  console.log('FILE INFO = ' + JSON.stringify(file));
                  console.log('FILE PATH = ' + file.path);



                  formYear=fName.substring(len+5,fName.length-5)
                  let cy = document.getElementById("formYear");
                  if(cy) cy.innerHTML = formYear;
                  console.log('CLIENT = ' + formClient);


                  let platformPath = file.path;
                  let cc = document.getElementById("formClient");
                  if(cc) cc.innerHTML = formClient;
                  console.log('YEAR = ' + formYear);
                  

                  var blob="empty URL";
                  reader = new FileReader();
                  reader.onload = function(){
                     blob = reader.result;
                     console.log("WELCOMEDROP.HTML readAsDataURL() "+blob.length);  
                     postToServer("MAINFILE",blob);
                  };
                  reader.readAsArrayBuffer(file);



                              let su = document.getElementById("SignUp");
                  if(su) su.innerHTML = aoaCells;
               }
            }
         }
      } else {
         // Use DataTransfer interface to access the file(s)
         for (var i = 0; i < ev.dataTransfer.files.length; i++) {
            console.log('OTHER ... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
         }
      }
   }


      function timeSymbol() {
         var u = new Date(Date.now()); 
         return ''+
         ('0' + (1+u.getUTCMonth())).slice(-2) +
         ('0' + u.getUTCDate()).slice(-2) + 
         ('0' + u.getUTCHours()).slice(-2) +
         ('0' + u.getUTCMinutes()).slice(-2) +
         ('0' + u.getUTCSeconds()).slice(-2) +
         (u.getUTCMilliseconds() / 1000).toFixed(3).slice(2, 5);
      };     


      const strServerDNS = 'http://'+self.location.hostname+':81/';

      const form = document.querySelector("#login");

      form.addEventListener('submit', function (event) {   
         var elements=form.elements; 
         event.preventDefault();
         login(event,elements);      
      } );

      var content="";


 
      function login(event,elements) {       

         let check = localStorage.getItem("mysession");
         if(check && check.length>10) {
            const credentials = {
            'sessionId':  localStorage.getItem("mysession"),
            'time': timeSymbol()
           };
           console.log("login() WITH PREVIOUS SESSION");
           // postAndDisplay("LOGIN",credentials,'mainpage');
           // SERVER NOT RECOGNIZING CERT Strings

         } else console.dir("login() NO PREVIOUS SESSION");
      

         //for(let name in ['CLIENT', 'YEAR', 'JSON']) 
         //);

         console.log("WELCOMEDROP CLIENT "+formClient);
         console.log("WELCOMEDROP YEAR   "+formYear);
        // console.log("WELCOME J  "+form[2].value);

            // post body data 
         const credentials = {
            'client':formClient,
            'year':  formYear,
            'sessionId':  localStorage.getItem("mysession"),
            'time': timeSymbol()
         };
       

         postAndDisplay("LOGIN",credentials,'mainpage');
         
      }
     
      
    /*
    var fileBuffer="";
    document.getElementById('fileupload').addEventListener('change', function () {
        var fr = new FileReader();
        fr.onload = function () {
        fileBuffer = this.result;
            
            console.log('UPLOAD '+fileBuffer);

            postToServer("UPLOAD",fileBuffer)
            
        };
    fr.readAsText(this.files[0]);
    });
    console.log('STARTED');
    */content
    </SCRIPT>
</body>
</html>
