<!DOCTYPE HTML>
<html  id='PageContent'>
    <link rel="stylesheet" href="./FBA/mobile_green.css"/>
<head>
    <TITLE>Mobile Balance - Abschlussbuchung</TITLE>        

    <SCRIPT type="text/javascript" src="/client.js"></SCRIPT>
    <SCRIPT type="text/javascript" src="/money.js"></SCRIPT>

    <script>
        var debug=null;

        var creditList={};
        var debitList={};
       
    </script>
</head>

<body>
    <div class="dosBorder">
        <div class="mTable" >
                <div class="ulliTab"  height="700px">
                    <DIV class="attrLine" id="welcome"></DIV>            
                    <DIV  id='selAccount'></DIV>
                    <DIV id='tabHistory'></DIV>
                    <DIV  id='display'>CLOSE</DIV>
                    <div class="attrLine">
                    <div class="R165" id="credit" ><div>Soll: 0,00</div></div>
                    <div class="C100"  >&nbsp;</div>
                    <div class="R165" id="debit" ><div>Haben 0,00</div></div>
                    <div class="L22"  >&nbsp;</div>
                    <div class="C100" id="buttons" >
                        <div class="L22"  >&nbsp;</div>
                        <DIV class="C100"><button id="read-button" onclick="getFromServer(putResponse)" )>Close</button> </DIV> 
                </div></div>
            </div>
        </div>
    </div>
  
    <SCRIPT type="text/javascript">

        // 20220424
        // character count for notmal columns
        let iCpField = 16;
        var page;
        var accountPages={};
        var cCent=0;

        var gResponse;
        var gAccounts;
        var gHistory;
        var gSchema;
        var gAssets;

        var paramString;
    
        
        function putResponse(strTarget,strText) {       

            console.log('CloseAndSave '+strTarget);

            gResponse = JSON.parse(strText);

            let gReport  = gResponse[D_Report];

            gHistory  = gResponse[D_History];
            gAccounts= gResponse[D_Balance];
            gSchema  = gResponse[D_Schema];
            gAssets = gResponse[D_FixAss];
            page = gResponse[D_Page];
            
            if(gSchema) {
                var author=gSchema.author;
                var residence=gSchema.residence;
                var iban=gSchema.iban;
                var register=gSchema.register;
                var taxnumber=gSchema.taxnumber;
                var reportYear=gSchema.reportYear;
                var client=gSchema.client;
                
                var cDisplay = document.getElementById("display");
                cDisplay.innerHTML = page["Closing"];

                /*
                var welcome = document.getElementById("welcome");
                welcome.innerHTML = "<DIV class='L120'>"+client
                +"</DIV><DIV class='L220'>"+register+"&nbsp;"+taxnumber
                +"</DIV><DIV class='L220'>"+iban+"&nbsp;"+reportYear
                +"</DIV><DIV class='L220'>"+author+"&nbsp; "+residence
                    +'</DIV><DIV class="C100"><button id="read-button" onclick="bookTax()" )>NEXT</button> '
                +"</DIV>";
                */
            }
            console.log('Schema='+JSON.stringify(gSchema));

            var txnTable = [];                

            // build history from given account as a prompt list
            if(gSchema && gSchema.Names && gSchema.Names.length>0) {
                var parts=gSchema.Names;

                let closing = JSON.parse(gReport.xbrlIncome.closing); //.split(CSEP);

                var jInfo = closing; // { "date":closing[1], "sender":closing[2], "refAcct":closing[3], "svwz":closing[4], "svwz2":closing[5], "credit":[], "debit":[]  };

                txnTable.push('<DIV class="attrLine">'
                +'<div class="L22" >&nbsp;</div>'
                +'<div class="C100" id="date" value="'+jInfo.date+'">'+jInfo.date+'</div>'
                +'<DIV class="L120">'+jInfo.sender+'</DIV>'      
                +'<DIV class="L120">'+jInfo.refAcct+'</DIV>'
                +'<DIV class="L120">'+jInfo.svwz+'</DIV>'
                +'<DIV class="L120">'+jInfo.svwz2+'</DIV>'
                +'</DIV>');


                var aTable = document.getElementById('selAccount');
                if(aTable) aTable.innerHTML = txnTable.join("");

                creditList= jInfo.credit;
                console.log("CREDIT = "+JSON.stringify(creditList));

                debitList = jInfo.debit;
                console.log("DEBIT = "+JSON.stringify(debitList));

                // override other year 
                jInfo.flag = 1;

                showClose(validateCD(creditList,debitList),'download');
            
            }               
        }

    
        function download(event) {
            console.log("1000 CloseAndSave Download ENTER");
            handleEvent(event);
            paramString = strTarget.split('?')[1];
            let sessionId = paramString.split('=')[1];
            console.log("1010 CloseAndSave params = "+paramString);
            console.log("1020 CloseAndSave sessionId = "+sessionId);
            Sheets.xlsxWrite(paramString.split('=')[1],null);         
            console.log("1100 CloseAndSave Download EXIT");
            closeWindow();
        }
    
        
        function closeWindow() {
            console.log("1200 CloseAndSave Close IN");
            window.close();
            console.log("1210 CloseAndSave Close OUT");
        }

        </script>
    </body>
</html>


